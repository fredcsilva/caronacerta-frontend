<!-- ✅ Menu-bar com título e subtítulo -->
<app-menu-bar
  [title]="'Dados Pessoais'"
  [subtitle]="'Passo 1 de 3'"
  [showBackButton]="false"
  [showLogoutButton]="true">
</app-menu-bar>

<div class="dados-pessoais-container">
  <p-toast key="tc" position="top-center"></p-toast>

  <div class="content-wrapper">
    <p-card>
      <!-- Conteúdo do formulário -->
      <div class="card-content">
        <form [formGroup]="dadosPessoaisForm" (ngSubmit)="salvarDadosPessoais()">

          <!-- ✅ NOVO: Avatar/Foto de Perfil -->
          <div class="field avatar-field">
            <label>Foto de Perfil</label>
            <div class="avatar-container">
              
              <!-- Avatar Display -->
              <div class="avatar-display" (click)="openImageModal()" [class.clickable]="avatarImageSrc">
                <p-avatar
                  *ngIf="avatarThumbnailSrc"
                  [image]="avatarThumbnailSrc"
                  shape="circle"
                  size="xlarge"
                  [style]="{ width: '120px', height: '120px', cursor: 'pointer' }"
                ></p-avatar>
                
                <p-avatar
                  *ngIf="!avatarThumbnailSrc"
                  icon="pi pi-user"
                  shape="circle"
                  size="xlarge"
                  [style]="{ 
                    width: '120px', 
                    height: '120px', 
                    backgroundColor: '#7E57C2',
                    color: '#FFFFFF'
                  }"
                ></p-avatar>
              </div>

              <!-- Upload Controls -->
              <div class="avatar-controls">
                <p-fileUpload
                  #fileUpload
                  mode="basic"
                  accept="image/png,image/jpeg,image/jpg"
                  [auto]="false"
                  [maxFileSize]="5242880"
                  (onSelect)="onFileSelect($event)"
                  chooseLabel="Selecionar Foto"
                  chooseIcon="pi pi-camera"
                  [style]="{ width: '100%' }"
                ></p-fileUpload>

                <p-button
                  *ngIf="avatarImageSrc"
                  icon="pi pi-trash"
                  severity="danger"
                  [text]="true"
                  (onClick)="removeAvatar()"
                  label="Remover"
                ></p-button>
              </div>

              <small class="avatar-hint">
                Formatos: PNG, JPEG ou JPG | Tamanho máximo: 5 MB
              </small>
            </div>
          </div>

          <!-- Data de Nascimento -->
          <div class="field">
            <label for="dataNascimento">Data de Nascimento *</label>
            <p-datepicker
              inputId="dataNascimento"
              formControlName="dataNascimento"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              [minDate]="minDataNascimento"
              [maxDate]="maxDataNascimento"
              placeholder="Selecione sua data de nascimento"
              [fluid]="true"
              [class.ng-invalid]="dadosPessoaisForm.get('dataNascimento')?.invalid && dadosPessoaisForm.get('dataNascimento')?.touched"
            ></p-datepicker>
            <small class="p-error" *ngIf="dadosPessoaisForm.get('dataNascimento')?.hasError('required') && dadosPessoaisForm.get('dataNascimento')?.touched">
              Data de nascimento é obrigatória.
            </small>
          </div>

          <!-- Telefone -->
          <div class="field">
            <label for="telefone">Telefone *</label>
            <p-inputmask
              inputId="telefone"
              formControlName="telefone"
              mask="(99) 99999-9999"
              placeholder="(00) 00000-0000"
              [fluid]="true"
              [class.ng-invalid]="dadosPessoaisForm.get('telefone')?.invalid && dadosPessoaisForm.get('telefone')?.touched"
            ></p-inputmask>
            <small class="p-error" *ngIf="dadosPessoaisForm.get('telefone')?.hasError('required') && dadosPessoaisForm.get('telefone')?.touched">
              Telefone é obrigatório.
            </small>
            <small class="p-error" *ngIf="dadosPessoaisForm.get('telefone')?.hasError('minlength') && dadosPessoaisForm.get('telefone')?.touched">
              Telefone deve ter 11 dígitos.
            </small>
          </div>

          <!-- Gênero -->
          <div class="field">
            <label for="genero">Gênero *</label>
            <p-select
              inputId="genero"
              formControlName="genero"
              [options]="generoOptions"
              placeholder="Selecione seu gênero"
              optionLabel="label"
              optionValue="value"
              [fluid]="true"
              [class.ng-invalid]="dadosPessoaisForm.get('genero')?.invalid && dadosPessoaisForm.get('genero')?.touched"
            ></p-select>
            <small class="p-error" *ngIf="dadosPessoaisForm.get('genero')?.hasError('required') && dadosPessoaisForm.get('genero')?.touched">
              Gênero é obrigatório.
            </small>
          </div>

          <!-- ✅ Botão Próximo -->
          <div class="button-group">
           <p-button
              type="submit"
              label="Próximo"
              icon="pi pi-arrow-right"
              iconPos="right"
              styleClass="p-button-primary w-full"
              [loading]="loading"
              [disabled]="dadosPessoaisForm.invalid"
            ></p-button>
          </div>
        </form>
      </div>
    </p-card>
  </div>

  <!-- ✅ Modal para visualizar imagem ampliada -->
  <p-dialog
    [(visible)]="displayImageModal"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="true"
    [style]="{ width: '90vw', maxWidth: '600px' }"
    header="Foto de Perfil"
  >
    <div class="image-modal-content">
      <img 
        *ngIf="avatarImageSrc" 
        [src]="avatarImageSrc" 
        alt="Foto de perfil ampliada"
        class="full-image"
      />
    </div>
  </p-dialog>
</div>